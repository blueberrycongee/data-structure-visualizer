<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obsidian 渲染器示例</title>
    <!-- 引入 marked.js, 这是一个 Markdown 解析器 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* --- 基本页面样式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f8f8f8;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        h1, h2 {
            border-bottom: 2px solid #eaeaea;
            padding-bottom: 5px;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .column {
            flex: 1;
            min-width: 300px;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #markdown-input {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: "Courier New", Courier, monospace;
            font-size: 14px;
        }

        #html-output {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            min-height: 400px;
            background-color: #fdfdfd;
        }

        /* --- Obsidian 特定语法 CSS --- */

        /* 1. [[双向链接]] 的样式 */
        .internal-link {
            color: #4a8ade; /* 链接颜色 */
            background-color: #eef5fc; /* 链接背景色 */
            border-radius: 3px;
            padding: 1px 4px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .internal-link:hover {
            background-color: #dceafc;
            text-decoration: underline;
        }

        /* 2. ==高亮== 的样式 */
        mark {
            background-color: #fcf8e3; /* 高亮颜色 */
            color: #8a6d3b;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* 3. >[!TYPE] Callouts 的样式 */
        .callout {
            border-radius: 8px;
            border-left: 5px solid;
            padding: 15px;
            margin: 15px 0;
            background-color: #f9f9f9;
        }
        .callout-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .callout-content {
            margin: 0;
        }
        .callout-content > :first-child {
            margin-top: 0;
        }
        .callout-content > :last-child {
            margin-bottom: 0;
        }

        /* Callout 的不同类型 */
        .callout-note {
            border-color: #4a8ade;
            background-color: #f0f6fd;
        }
        .callout-note .callout-title {
            color: #4a8ade;
        }

        .callout-warning {
            border-color: #f0ad4e;
            background-color: #fcf8e3;
        }
        .callout-warning .callout-title {
            color: #f0ad4e;
        }

        .callout-danger {
            border-color: #d9534f;
            background-color: #f2dede;
        }
        .callout-danger .callout-title {
            color: #d9534f;
        }

    </style>
</head>
<body>

    <h1>Obsidian 笔记渲染示例</h1>
    <p>在左侧的文本框中输入 Obsidian 语法的 Markdown，右侧会实时显示渲染后的 HTML 效果。</p>

    <div class="container">
        <div class="column">
            <h2>输入 (Obsidian Markdown)</h2>
            <textarea id="markdown-input"></textarea>
        </div>
        
        <div class="column">
            <h2>输出 (渲染后的 HTML)</h2>
            <div id="html-output"></div>
        </div>
    </div>

    <script>
        // 示例文本
        const sampleMarkdown = `
# 笔记标题

这是一段普通文本，包含一个 [[双向链接]] 和另一个 [[带别名的链接|显示文本]]。

## 语法高亮

我们还可以 ==高亮显示== 一些重要的词。

## Callouts

这是一个 callout 示例：

>[!NOTE] 这是一个笔记
>这是笔记的内容。
>
>它可以包含多行。

>[!WARNING] 这是一个警告
>请注意这里的内容！

>[!DANGER] 这是一个危险提示
>这里有严重问题。
`

        // 获取 DOM 元素
        const input = document.getElementById('markdown-input');
        const output = document.getElementById('html-output');

        // --- 修复：使用 marked.js 扩展 API ---

        // --- 1. Callout 扩展 (块级) ---
        const calloutExtension = {
            name: 'callout',
            level: 'block',
            start(src) { return src.match(/>\[!/)?.index; }, // 快速检查
            tokenizer(src, tokens) {
                const rule = /^(?:>[ ]?\[!([A-Z]+)\](.*?)\n)((?:>[ ]?.*\n?)*)/;
                const match = rule.exec(src);
                
                if (match) {
                    // FIX: Renamed 'type' to 'calloutType' to avoid conflict
                    const calloutType = match[1].toLowerCase();
                    const title = match[2].trim() || calloutType.charAt(0).toUpperCase() + calloutType.slice(1);
                    
                    // 获取内容并移除 '>' 符号
                    const rawContent = match[3] || '';
                    const content = rawContent.split('\n').map(line => {
                        return line.replace(/^>[ ]?/, '');
                    }).join('\n');

                    const token = {
                        type: 'callout', // This MUST match the extension 'name'
                        raw: match[0],
                        calloutType: calloutType, // Custom property for 'note', 'warning' etc.
                        title: title,
                        text: content,
                        tokens: []
                    };
                    
                    // 递归地解析 callout 内部的
                    this.lexer.blockTokens(token.text, token.tokens);
                    
                    return token;
                }
            },
            renderer(token) {
                const contentHtml = this.parser.parse(token.tokens);
                return `
                    <div class="callout callout-${token.calloutType}">
                        <div class="callout-title">
                            <!-- 你可以在这里添加 SVG 图标 -->
                            <span>${token.title}</span>
                        </div>
                        <div class="callout-content">
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }
        };

        // --- 2a. 高亮 (==text==) 扩展 ---
        const highlightExtension = {
            name: 'highlight',
            level: 'inline',
            start(src) { return src.match(/==/)?.index; }, // 快速检查
            tokenizer(src, tokens) {
                const rule = /^==([^=]+)==/;
                const match = rule.exec(src);
                if (match) {
                    return {
                        type: 'highlight', // 必须与 'name' 匹配
                        raw: match[0],
                        text: match[1],
                    };
                }
            },
            renderer(token) {
                return `<mark>${token.text}</mark>`;
            }
        };

        // --- 2b. 双向链接 ([[link]]) 扩展 ---
        const wikilinkExtension = {
            name: 'wikilink',
            level: 'inline',
            start(src) { return src.match(/\[\[/)?.index; }, // 快速检查
            tokenizer(src, tokens) {
                const rule = /^\[\[([^\]]+)\]\]/;
                const match = rule.exec(src);
                if (match) {
                    const content = match[1];
                    const parts = content.split('|');
                    const link = parts[0];
                    const text = parts[1] || parts[0];
                    return {
                        type: 'wikilink', // 必须与 'name' 匹配
                        raw: match[0],
                        link: link,
                        text: text
                    };
                }
            },
            renderer(token) {
                const href = token.link.replace(/ /g, '-').toLowerCase() + '.html';
                return `<a href="${href}" class="internal-link">${token.text}</a>`;
            }
        };


        // 设置 marked 使用我们的自定义扩展
        marked.use({
            extensions: [calloutExtension, highlightExtension, wikilinkExtension]
        });

        // 渲染函数
        function renderMarkdown() {
            const md = input.value;
            output.innerHTML = marked.parse(md);
        }

        // 初始化
        input.value = sampleMarkdown.trim();
        renderMarkdown();

        // 监听输入变化
        input.addEventListener('input', renderMarkdown);

    </script>

</body>
</html>