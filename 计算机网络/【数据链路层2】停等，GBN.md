

### **第三部分：数据链路层 (续) - 滑动窗口协议**

1.  **引言与基础概念**
    *   **协议栈实现**：物理层和部分数据链路层功能通常由硬件（如网卡）实现，而数据链路层的其他部分和网络层则作为操作系统的一部分，由软件（如设备驱动）实现。
    *   **协议回顾**：讲师跳过了基础的、理论性的协议1、2、3，直接从实际应用的协议4（停止-等待）、协议5（回退N帧）和协议6（选择重传）开始讲解。
    *   **确认机制**：
        *   **哑帧确认 (Dummy ACK)**：一个只包含确认信息、没有数据载荷的空帧。效率较低。
        *   **捎带确认 (Piggybacking)**：当通信双方（A和B）都有数据要发送时，B可以在自己发往A的数据帧中，顺便“捎带”上对A之前发来数据的确认信息。这种方式能有效利用信道带宽，减少帧的数量。

2.  **协议四：一比特滑动窗口协议 (停止-等待协议)**
    *   **核心特点**：
        *   发送窗口大小 = 1，接收窗口大小 = 1。
        *   发送方**一次只发送一帧**，然后必须**停止**并**等待**接收方的确认，收到确认后才能发送下一帧。
    *   **工作流程**：
        *   **发送方**：发送一帧后，启动一个**计时器 (Timer)**。如果在计时器超时前收到了正确的确认，就发送下一帧；如果超时，则认为帧丢失或损坏，**重传**当前帧。
        *   **接收方**：接收到正确的帧后，发送一个确认帧。
    *   **问题**：由于“发一帧，等一帧”的机制，信道在大部分时间处于空闲状态，导致**信道利用率极低**。

3.  **流水线技术与滑动窗口协议**
    *   **思想**：为了提高信道利用率，允许发送方连续发送多个帧，而无需等待每一个帧的确认，就像流水线一样。
    *   **实现方式**：通过**滑动窗口协议 (Sliding Window Protocol)** 实现。
    *   **窗口 (Window)**：
        *   **发送窗口**：发送方维护的一个序号范围，表示已发送但尚未收到确认的帧。
        *   **接收窗口**：接收方维护的一个序号范围，表示允许接收的帧。
    *   **窗口滑动**：当收到确认或成功接收帧后，窗口会向前（向右）滑动。

4.  **协议五：回退N帧协议 (Go-Back-N, GBN)**
    *   **核心特点**：
        *   **发送窗口大小 (W_S) > 1**。
        *   **接收窗口大小 (W_R) = 1**。
    *   **工作流程**：
        *   **发送方**：可以连续发送发送窗口内的所有帧。
        *   **接收方**：
            *   只接收**按序到达**的、序号正确的帧。
            *   如果收到的帧是期望的序号，则接收该帧，并将窗口向前滑动一格，然后发送对该帧的确认。
            *   如果收到**乱序**或**损坏**的帧，则**直接丢弃**，并重新发送对上一个已正确接收帧的确认（**累计确认**）。
        *   **差错处理**：
            *   当发送方计时器超时（意味着某个帧未被确认），它会**“回退”**到那个未被确认的帧，并**重传该帧及其之后所有已发送的帧**。
    *   **累计确认 (Cumulative ACK)**：接收方发送`ACK n`，表示序号`n`以及`n`之前的所有帧都已正确接收。这可以减少确认帧的数量。
    *   **缺点**：当网络质量差、丢包率高时，一个错误会导致大量后续正确的帧被不必要地重传，造成带宽浪费。

5.  **GBN协议发送窗口大小的限制 (核心考点)**
    *   **问题**：如果使用`n`个比特来表示帧序号（序号空间为`0`到`2^n - 1`），那么GBN协议的最大发送窗口大小是多少？
    *   **结论**：最大发送窗口大小 `W_S` 必须**小于**序号空间的大小，即 `W_S ≤ 2^n - 1`。**不能等于 `2^n`**。
    *   **原因详解**：
        *   **场景假设**：假设`n=3`，序号空间为0-7（共8个）。如果允许发送窗口大小`W_S = 8`。
        *   **歧义产生**：
            1.  **情况A（全部成功）**：发送方发送了0-7号帧，接收方全部收到，并发送了`ACK 7`。
            2.  **情况B（全部丢失）**：发送方发送了0-7号帧，但所有这些帧以及接收方发出的所有确认帧都丢失了。
        *   **无法区分**：在这两种情况下，发送方最终都会因为超时而没有收到对新一轮0-7号帧的确认，同时它之前可能收到的最后一个有效确认是`ACK 7`（来自上一轮）。此时，发送方无法判断是新一轮的帧全部丢失了（情况B），还是新一轮的帧全部成功但确认帧丢失了（情况A的变种）。
        *   **解决方案**：将窗口大小限制在`2^n - 1`（如7）。这样，当一轮成功的传输（0-6号帧）结束后，接收方会期待7号帧，而发送方窗口滑动后会从7号帧开始发送。如果发生全丢失的情况，接收方仍然期待0号帧。通过接收方期待的序号不同，发送方就能区分这两种情况。

### **课程安排预告**

*   讲师计划在休息后继续讲解**协议六：选择重传协议 (Selective Repeat, SR)**，并讲解关于信道利用率和序号位数的计算例题，完成数据链路层的主要内容。